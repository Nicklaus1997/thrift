# thrift

## Introduction
 Thrift is a lightweight, language-independent software stack for point-to-point remote procedure call (RPC) implementations. It provides clear abstraction and implementation for data transmission, data serialization, and application-level processing. The code generation system uses a simple definition language as input and generates code across programming languages that uses abstract stacks to build interoperable RPC clients and servers.

### How to Install

```shell
ohpm install @ohos/thrift
```

For details about the OpenHarmony ohpm environment configuration, see [OpenHarmony HAR](https://gitee.com/openharmony-tpc/docs/blob/master/OpenHarmony_har_usage.en.md).

# How to Use

Thrift uses a **.thrift** text file to generate an OpenHarmony model class. You can customize the model class used by the tool to generate OpenHarmony **.thrift** files. The files generated by the tool must be copied to the client and server paths. The generated model class is used to develop client and server applications for gRPC calls. The client makes a gRPC call based on the supported protocol and transport layer configuration request.

```

import {Thrift} from '@ohos/thrift';
import {CalculatorClient} from '../../common/calculator/Calculator';
import {Work, Operation} from '../../common/calculator/tutorial_types';

try {
    //Example with url and without
    let transport: ESObject = new Thrift.Transport("http://106.15.92.248:5555");
    //let transport = new Thrift.Transport();
    let protocol: ESObject = new Thrift.Protocol(transport);
    let client: CalculatorClient = new CalculatorClient(protocol);

    let that: ESObject = this;
    
    let workI8Add = new WorkI8()  // Generated Class Work can be customized based on the user requirement.
    workI8Add.num1 = 1;
    workI8Add.num2 = 15;
    workI8Add.op = Operation.ADD; // Operation can be customized based on the user requirement.
    client.calculateI8(1, workI8Add, function (result) {
        if (result) {
            that.i8add = 'I8 ADD:'+result;
        }
    });
 } catch (error) {
   console.info("Thrift" + error.getMessage())
 }

```
## Thrift Compiler

For details about how to install Thrift, [click here](http://thrift.apache.org/docs/install/).

After creating a **.thrift** file, you can run Thrift to generate code in the target language. Use the **Thrift** command as follows:

```
thrift [options] file
thrift -r --gen language[java/js/py etc] filename.thrift
```

1. For using Thrift in the sample application, obtain the compiler and tools in the **compiler** folder.

2. The generated warpper tool is used to generate the **.thrift** files corresponding to the OpenHarmony JS files on the Windows (PowerShell) and Linux platforms.

### How to Use thrift on Linux

1. Obtain binary files
   Method 1: Find the latest compiled PR, and there will be a link to the access control report in the comment section;
   Method 2: Propose a PR yourself, trigger the access control, and compile a successful access control report link;
2. Click on the access control report and you can see that tpc_component has been compiled successfully. After clicking on 'pass', select the log details and expand' version '. Below is a compressed file,
   This compressed file contains the required binary file * * thrift. sh * *;
3. Place the compiler and **thrift.sh** in the same folder.
4. Use the **input .thrift** file to execute **thrift.sh**.
5. Obtain the generated files in the **JS** and **OpenHarmony** folders.

```
./thrift.sh  tutorial.thrift
```

### How to Use thrift on Windows

1. Start PowerShell.
2. Open PowerShell ISE (run **PowerShell ISE** in the PowerShell prompt).
3. Run the following command to go to the folder where **thrift.ps1** and **thrift compiler.exe** are located.
4. Use the **input.thrift** file to run the tool.
5. Obtain the generated files in the **JS** and **OpenHarmony** folders.

```
.\thrift.ps1 eg.thrift
```

## Available APIs

**new Thrift.Transport(/* Pass Server URL */)** // Creates a Transport object.

**new Thrift.TJSONProtocol(/* Pass Transport object */)** // Creates a TJSONProtocol object. Note that the TJSON protocol is the same as the protocol.

**new Thrift.TException().getMessage();** // If the URL does not exist, obtains the error information in the capture block.

## About obfuscation
- Code obfuscation, please see[Code Obfuscation](https://docs.openharmony.cn/pages/v5.0/zh-cn/application-dev/arkts-utils/source-obfuscation.md)
- If you want the thrift library not to be obfuscated during code obfuscation, you need to add corresponding exclusion rules in the obfuscation rule configuration file obfuscation-rules.txtï¼š
```
-keep
./oh_modules/@ohos/thrift
```

## Constraints

This project has been verified in the following versions:

- DevEco Studio: 4.1 Canary (4.1.3.317)

- OpenHarmony SDK: API 11 (4.1.0.36)

## Directory Structure
````
|---- Thrift
|     |---- compiler # Compilers and tools for Windows and Linux
|     |---- entry # Sample code
|     |---- server # Server code used to perform thrift operations
|     |-- library # thrift library
|     |-- README.md # Readme
|     |-- README_zh.md # Readme
````

## How to Contribute

If you find any problem when using the project, submit an [issue](https://gitee.com/openharmony-tpc/thrift/issues) or a [PR](https://gitee.com/openharmony-tpc/thrift/pulls).

## License

This project is licensed under the terms of the [Apache License 2.0](https://gitee.com/openharmony-tpc/thrift/blob/master/LICENSE).
